{% extends "base.html" %}

{% block title %}Admin Dashboard - Savage Homeschool OS{% endblock %}

{% block content %}
<!-- Welcome Header -->
<div class="welcome-message">
    <h1><i class="fas fa-user-shield"></i> Admin Dashboard</h1>
    <p class="mb-0">Full system control and management for Savage Homeschool OS</p>
</div>

<!-- System Stats -->
<div class="row">
    <div class="col-md-3">
        <div class="dashboard-stats text-center">
            <i class="fas fa-users" style="font-size: 2rem; color: var(--secondary-color);"></i>
            <h3 class="mt-2">{{ users|length }}</h3>
            <p class="text-muted mb-0">Total Users</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="dashboard-stats text-center">
            <i class="fas fa-book" style="font-size: 2rem; color: var(--success-color);"></i>
            <h3 class="mt-2">{{ lessons|length }}</h3>
            <p class="text-muted mb-0">Total Lessons</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="dashboard-stats text-center">
            <i class="fas fa-chart-line" style="font-size: 2rem; color: var(--warning-color);"></i>
            <h3 class="mt-2">{{ total_progress }}</h3>
            <p class="text-muted mb-0">Progress Records</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="dashboard-stats text-center">
            <i class="fas fa-database" style="font-size: 2rem; color: var(--info-color);"></i>
            <h3 class="mt-2">{{ db_size }}</h3>
            <p class="text-muted mb-0">Database Size</p>
        </div>
    </div>
</div>

<!-- Main Content Tabs -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="adminTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                            <i class="fas fa-users"></i> Users
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="content-tab" data-bs-toggle="tab" data-bs-target="#content" type="button" role="tab">
                            <i class="fas fa-book"></i> Content
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">
                            <i class="fas fa-upload"></i> Upload
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button" role="tab">
                            <i class="fas fa-cog"></i> System
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button" role="tab">
                            <i class="fas fa-chart-bar"></i> Activity
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="adminTabsContent">
                    <!-- Users Tab -->
                    <div class="tab-pane fade show active" id="users" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>User Management</h5>
                            <button class="btn btn-primary" onclick="showAddUserModal()">
                                <i class="fas fa-plus"></i> Add User
                            </button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Role</th>
                                        <th>Grade Level</th>
                                        <th>Status</th>
                                        <th>Last Login</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in users %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img src="{{ user.avatar_data or '/static/avatars/default.png' }}" 
                                                     class="avatar me-2" alt="{{ user.username }}">
                                                {{ user.username }}
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'danger' if user.role == 'admin' else 'primary' if user.role == 'parent' else 'success' }}">
                                                {{ user.role.title() }}
                                            </span>
                                        </td>
                                        <td>{{ user.grade_level or 'N/A' }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if user.is_active else 'danger' }}">
                                                {{ 'Active' if user.is_active else 'Inactive' }}
                                            </span>
                                        </td>
                                        <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary" onclick="editUser({{ user.id }})" aria-label="Edit user">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser({{ user.id }})" aria-label="Delete user">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Content Tab -->
                    <div class="tab-pane fade" id="content" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Content Management</h5>
                            <div>
                                <button class="btn btn-success me-2" onclick="importFromAPI()">
                                    <i class="fas fa-download"></i> Import from API
                                </button>
                                <button class="btn btn-primary" onclick="createCustomLesson()">
                                    <i class="fas fa-plus"></i> Create Lesson
                                </button>
                            </div>
                        </div>
                        
                        <div class="row">
                            {% for subject in subjects %}
                            <div class="col-md-4 mb-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>{{ subject.name }}</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted">Grade {{ subject.grade_level }}</p>
                                        <p class="text-muted">{{ subject.lessons|length }} lessons</p>
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewSubject({{ subject.id }})">
                                            View Lessons
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Upload Tab -->
                    <div class="tab-pane fade" id="upload" role="tabpanel">
                        <h5>Upload Content</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="fas fa-file-upload"></i> Upload from Education.com</h6>
                                    </div>
                                    <div class="card-body">
                                        <form method="POST" action="{{ url_for('upload_lesson') }}" enctype="multipart/form-data">
                                            <div class="mb-3">
                                                <label for="file" class="form-label">Select File</label>
                                                <input type="file" class="form-control" id="file" name="file" accept=".pdf,.doc,.docx,.txt">
                                            </div>
                                            <div class="mb-3">
                                                <label for="subject" class="form-label">Subject</label>
                                                <select class="form-select" id="subject" name="subject" required>
                                                    <option value="">Choose subject...</option>
                                                    {% for subject in subjects %}
                                                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="grade_level" class="form-label">Grade Level</label>
                                                        <select class="form-select" id="grade_level" name="grade_level" required>
                                                            <option value="">Choose grade...</option>
                                                            {% for grade in range(1, 13) %}
                                                            <option value="{{ grade }}">Grade {{ grade }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="level" class="form-label">Level</label>
                                                        <select class="form-select" id="level" name="level" required>
                                                            <option value="">Choose level...</option>
                                                            {% for level in range(1, 6) %}
                                                            <option value="{{ level }}">Level {{ level }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="lesson_type" class="form-label">Lesson Type</label>
                                                <select class="form-select" id="lesson_type" name="lesson_type" required>
                                                    <option value="">Choose type...</option>
                                                    <option value="teaching">Teaching</option>
                                                    <option value="practice">Practice</option>
                                                    <option value="quiz">Quiz</option>
                                                    <option value="custom">Custom</option>
                                                </select>
                                            </div>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-upload"></i> Upload Lesson
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="fas fa-magic"></i> Auto-Generate from APIs</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="api_source" class="form-label">API Source</label>
                                            <select class="form-select" id="api_source">
                                                <option value="">Choose API...</option>
                                                <option value="khan">Khan Academy</option>
                                                <option value="nasa">NASA</option>
                                                <option value="openlibrary">OpenLibrary</option>
                                                <option value="ck12">CK-12</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="api_topic" class="form-label">Topic</label>
                                            <input type="text" class="form-control" id="api_topic" placeholder="e.g., fractions, space, coding">
                                        </div>
                                        <div class="mb-3">
                                            <label for="api_grade" class="form-label">Grade Level</label>
                                            <select class="form-select" id="api_grade">
                                                <option value="">Choose grade...</option>
                                                {% for grade in range(1, 13) %}
                                                <option value="{{ grade }}">Grade {{ grade }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <button class="btn btn-success" onclick="generateFromAPI()">
                                            <i class="fas fa-magic"></i> Generate Lesson
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System Tab -->
                    <div class="tab-pane fade" id="system" role="tabpanel">
                        <h5>System Management</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="fas fa-database"></i> Backup & Restore</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-primary" onclick="createBackup()">
                                                <i class="fas fa-download"></i> Create Backup
                                            </button>
                                            <button class="btn btn-warning" onclick="showRestoreModal()">
                                                <i class="fas fa-upload"></i> Restore Backup
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="fas fa-chart-pie"></i> System Stats</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-6">
                                                <small class="text-muted">Database Size</small>
                                                <h6>{{ db_size }}</h6>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Cache Size</small>
                                                <h6>{{ cache_size }}</h6>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Uploads</small>
                                                <h6>{{ uploads_count }}</h6>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Logs</small>
                                                <h6>{{ logs_count }}</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Activity Tab -->
                    <div class="tab-pane fade" id="activity" role="tabpanel">
                        <h5>Recent Activity</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Activity</th>
                                        <th>Description</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for activity in activities %}
                                    <tr>
                                        <td>{{ activity.user.username }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if 'complete' in activity.activity_type else 'primary' if 'start' in activity.activity_type else 'info' }}">
                                                {{ activity.activity_type.replace('_', ' ').title() }}
                                            </span>
                                        </td>
                                        <td>{{ activity.description }}</td>
                                        <td>{{ activity.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="mb-3">
                        <label for="new_username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="new_username" required>
                    </div>
                    <div class="mb-3">
                        <label for="new_email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="new_email" required>
                    </div>
                    <div class="mb-3">
                        <label for="new_role" class="form-label">Role</label>
                        <select class="form-select" id="new_role" required>
                            <option value="">Choose role...</option>
                            <option value="admin">Admin</option>
                            <option value="parent">Parent</option>
                            <option value="child">Child</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="new_grade" class="form-label">Grade Level</label>
                        <select class="form-select" id="new_grade">
                            <option value="">Choose grade...</option>
                            {% for grade in range(1, 13) %}
                            <option value="{{ grade }}">Grade {{ grade }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="new_pin" class="form-label">PIN (for child accounts)</label>
                        <input type="password" class="form-control" id="new_pin" maxlength="6" pattern="[0-9]*">
                        <small class="text-muted">6-digit PIN for child login</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">Save User</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // User management
    function showAddUserModal() {
        const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
        modal.show();
    }
    
    function saveUser() {
        const formData = {
            username: document.getElementById('new_username').value,
            email: document.getElementById('new_email').value,
            role: document.getElementById('new_role').value,
            grade_level: document.getElementById('new_grade').value,
            pin: document.getElementById('new_pin').value
        };
        
        fetch('/api/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Error creating user: ' + data.error);
            }
        });
    }
    
    function editUser(userId) {
        // TODO: Implement user editing
        alert('User editing coming soon!');
    }
    
    function deleteUser(userId) {
        if (confirm('Are you sure you want to delete this user?')) {
            fetch(`/api/users/${userId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('Error deleting user: ' + data.error);
                }
            });
        }
    }
    
    // Content management
    function importFromAPI() {
        // TODO: Implement API import
        alert('API import coming soon!');
    }
    
    function createCustomLesson() {
        // TODO: Implement custom lesson creation
        alert('Custom lesson creation coming soon!');
    }
    
    function viewSubject(subjectId) {
        // TODO: Implement subject view
        alert('Subject view coming soon!');
    }
    
    function generateFromAPI() {
        const source = document.getElementById('api_source').value;
        const topic = document.getElementById('api_topic').value;
        const grade = document.getElementById('api_grade').value;
        
        if (!source || !topic || !grade) {
            alert('Please fill in all fields');
            return;
        }
        
        // TODO: Implement API lesson generation
        alert('API lesson generation coming soon!');
    }
    
    // System management
    function createBackup() {
        fetch('/api/backup', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Backup created successfully!');
            } else {
                alert('Error creating backup: ' + data.error);
            }
        });
    }
    
    function showRestoreModal() {
        // TODO: Implement restore modal
        alert('Restore functionality coming soon!');
    }
</script>
{% endblock %} 